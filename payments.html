<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª | Ù‚ØµØ± Ø§Ù„Ù…Ø§Ø³Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="assets/css/style.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.stat-card{
background:linear-gradient(135deg,#1e3a8a,#2563eb);
border-radius:16px;
padding:20px;
text-align:center;
color:white;
box-shadow:0 10px 25px rgba(0,0,0,.4);
}
.stat-card h3{font-weight:800;}
</style>
</head>

<body class="dark">

<!-- Loader -->
<div class="loader">
<img src="assets/img/diamond.png">
</div>

<!-- Header -->
<div class="header">
<button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
<h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h4>
<button onclick="toggleMode()" class="btn btn-sm btn-warning">ğŸŒ™ / â˜€</button>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
<a href="index.html">ğŸ  Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
<a href="clients.html">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
<a href="bookings.html">ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</a>
<a href="payments.html" class="active-link">ğŸ’° Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</a>
<a href="reports.html">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
</div>

<!-- Main -->
<div class="main">

<!-- Statistics -->
<div class="row g-4 mb-4">

<div class="col-md-4">
<div class="stat-card">
<h6>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯</h6>
<h3 id="totalContracts">0</h3>
</div>
</div>

<div class="col-md-4">
<div class="stat-card">
<h6>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h6>
<h3 id="totalPaid">0</h3>
</div>
</div>

<div class="col-md-4">
<div class="stat-card">
<h6>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h6>
<h3 id="totalRemaining">0</h3>
</div>
</div>

</div>

<!-- Chart -->
<div class="card-box mb-4">
<h6 class="mb-3">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h6>
<canvas id="revenueChart" height="90"></canvas>
</div>

<!-- Form -->
<div class="card-box mb-4">
<form id="paymentForm" class="row g-3">

<div class="col-md-4">
<label>Ø§Ù„Ø­Ø¬Ø²</label>
<select id="bookingSelect" class="form-control" required></select>
</div>

<div class="col-md-3">
<label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
<input type="number" id="amount" class="form-control" required>
</div>

<div class="col-md-3">
<label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
<input type="date" id="paymentDate" class="form-control" required>
</div>

<div class="col-md-2 d-flex align-items-end">
<button class="btn btn-success w-100">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
</div>

</form>
</div>

<!-- Table -->
<div class="card-box">
<table class="table table-bordered text-center align-middle">
<thead class="table-dark">
<tr>
<th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
<th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
<th>Ø¥ÙŠØµØ§Ù„</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="paymentTable"></tbody>
</table>
</div>

</div>

<script src="assets/js/app.js"></script>

<script>

let clients = JSON.parse(localStorage.getItem("clients")) || [];
let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
let payments = JSON.parse(localStorage.getItem("payments")) || [];

function savePayments(){
localStorage.setItem("payments", JSON.stringify(payments));
}

function calculateRemaining(bookingId){
let booking = bookings.find(b=>b.id==bookingId);
if(!booking) return 0;

let paid = payments
.filter(p=>p.bookingId==bookingId)
.reduce((sum,p)=>sum + Number(p.amount),0);

return booking.total - paid;
}

function animate(id,value){
let obj=document.getElementById(id);
let start=0;
let duration=800;
let step=value/50;
let counter=setInterval(()=>{
start+=step;
if(start>=value){
obj.innerText=value+" Ø±ÙŠØ§Ù„";
clearInterval(counter);
}else{
obj.innerText=Math.floor(start)+" Ø±ÙŠØ§Ù„";
}
},duration/50);
}

function updateStats(){
let totalContracts = bookings.reduce((s,b)=>s+b.total,0);
let totalPaid = payments.reduce((s,p)=>s+p.amount,0);
let remaining = totalContracts - totalPaid;

animate("totalContracts",totalContracts);
animate("totalPaid",totalPaid);
animate("totalRemaining",remaining);
}

function loadBookings(){
bookingSelect.innerHTML="";
bookings.forEach(b=>{
let client = clients.find(c=>c.id==b.clientId);
bookingSelect.innerHTML+=`
<option value="${b.id}">
${client?.name || "-"} - ${b.date}
</option>`;
});
}

function renderPayments(){
paymentTable.innerHTML="";

payments.forEach(p=>{
let booking = bookings.find(b=>b.id==p.bookingId);
let client = clients.find(c=>c.id==booking?.clientId);
let remain = calculateRemaining(p.bookingId);

paymentTable.innerHTML+=`
<tr>
<td>${client?.name || "-"}</td>
<td>${p.amount} Ø±ÙŠØ§Ù„</td>
<td>${p.date}</td>
<td class="${remain>0?'text-danger fw-bold':'text-success fw-bold'}">
${remain} Ø±ÙŠØ§Ù„
</td>
<td>
<button class="btn btn-primary btn-sm" onclick="printReceipt(${p.id})">ğŸ§¾</button>
</td>
<td>
<button class="btn btn-danger btn-sm" onclick="deletePayment(${p.id})">ğŸ—‘</button>
</td>
</tr>`;
});

updateStats();
drawChart();
}

function deletePayment(id){
payments = payments.filter(p=>p.id!=id);
savePayments();
renderPayments();
}

paymentForm.addEventListener("submit",function(e){
e.preventDefault();

let bookingId = bookingSelect.value;
let amountValue = Number(amount.value);

if(amountValue > calculateRemaining(bookingId)){
alert("âš  Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¯ÙØ¹ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ");
return;
}

payments.push({
id: Date.now(),
bookingId,
amount: amountValue,
date: paymentDate.value
});

savePayments();
this.reset();
renderPayments();
});

function printReceipt(id){
let payment = payments.find(p=>p.id==id);
let booking = bookings.find(b=>b.id==payment.bookingId);
let client = clients.find(c=>c.id==booking.clientId);

let receipt = `
Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹ - Ù‚ØµØ± Ø§Ù„Ù…Ø§Ø³Ø©

Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client.name}
Ø§Ù„Ù…Ø¨Ù„Øº: ${payment.amount} Ø±ÙŠØ§Ù„
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${payment.date}

Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§ ğŸ’
`;

let w = window.open("");
w.document.write("<pre>"+receipt+"</pre>");
w.print();
}

function drawChart(){

let monthly = {};

payments.forEach(p=>{
let month = p.date.substring(0,7);
monthly[month] = (monthly[month] || 0) + Number(p.amount);
});

let labels = Object.keys(monthly);
let data = Object.values(monthly);

new Chart(document.getElementById("revenueChart"),{
type:"bar",
data:{
labels:labels,
datasets:[{
data:data,
borderRadius:8
}]
},
options:{
plugins:{legend:{display:false}},
scales:{y:{beginAtZero:true}}
}
});
}

loadBookings();
renderPayments();

</script>

</body>
</html>
